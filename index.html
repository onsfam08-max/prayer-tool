<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìœ ì¹˜ë¶€ íŒ€ ë³´ê³ ì„œ ì œì¶œìš©</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; line-height: 1.35; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    label { display: flex; flex-direction: column; gap: 6px; min-width: 290px; flex: 1; }
    input, select, button, textarea { padding: 10px; font-size: 14px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; border: 1px solid #bbb; background: #fff; }
    button.primary { border-color: #333; }
    .muted { color: #666; font-size: 13px; }
    .error { color: #b00020; white-space: pre-wrap; }
    .ok { color: #0a7a3b; }
    show { white-space: pre-wrap; }
    textarea { width: 100%; min-height: 260px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .pill { display:inline-block; padding: 2px 10px; border-radius: 999px; background:#f2f2f2; font-size: 12px; margin-right: 6px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; so:1; }
  </style>
</head>
<body>
  <h2>ğŸ”¥ìœ ì¹˜ë¶€ íŒ€ë³´ê³ ì„œ ì œì¶œìš©ğŸ”¥</h2>
  <p class="muted">
	<span style="font-weight:700; font-size:15px; color:#222;">>> ì‚¬ìš© ë°©ë²•</span><br/>
	â‘¥ ì›í•˜ëŠ” ë‚ ì§œ ë„£ê³  íŒ€ ì„ íƒ í›„<br/>	
	â‘¦ ê°€ì ¸ì˜¤ê¸° & ìƒì„±ë²„íŠ¼ ëˆŒëŸ¬ì„œ ë³´ê³ ì„œ ìƒì„±<br/>
	â‘§ ë©”ì„¸ì§€ì°½ ìœ„ copyë²„íŠ¼ ëˆŒëŸ¬ ë°°í¬<br/><br/>
	
	<span style="font-weight:700; font-size:15px; color:#222;">>> ë§í¬ê°€ ë°”ë€Œê±°ë‚˜ ì´ëª¨ì§€ë¥¼ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´</span><br/>
	â‘  ë“œë¦¼/ìš°ë¦¬/ì„¬ê¹€/ì˜ˆë°° ê°ê° ì‹œíŠ¸ ë§í¬ ë¶™ì—¬ ë„£ê¸°<br/>
	â‘¡ ë‚ ì§œ ë„£ê³  ex)2026-01-18<br/>
    â‘¢ íŒ€ ì„ íƒ <br/>
	â‘£ ì´ëª¨ì§€ë„ ë„£ì–´ì£¼ê³ <br/>
	â‘¤ ì„¤ì •ì €ì¥ ë²„íŠ¼ í´ë¦­(ìµœì´ˆ 1ë²ˆë§Œ)<br/>
	- ì´í›„ë¶€í„°ëŠ” â‘¥â‘¦ë§Œ ë°˜ë³µ
  </p>

  <div class="card">
    <div class="row">
      <label>
        ë“œë¦¼ë°˜ ë§í¬
        <input id="dreamUrl" placeholder="https://docs.google.com/spreadsheets/d/.../edit?gid=..." />
        <span class="muted">ê³µìœ : ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì â€˜ë³´ê¸°â€™ ê°€ëŠ¥ ìƒíƒœì—¬ì•¼ í•¨</span>
      </label>
      <label>
        ìš°ë¦¬ë°˜ ë§í¬
        <input id="uriUrl" placeholder="https://docs.google.com/spreadsheets/d/.../edit?gid=..." />
      </label>
	  <label>
		ì„¬ê¹€ ë§í¬
		<input id="serveUrl" placeholder="https://docs.google.com/spreadsheets/d/.../edit?gid=..." />
	  </label>
	  <label>
		ì˜ˆë°° ë§í¬
		<input id="worshipUrl" placeholder="https://docs.google.com/spreadsheets/d/.../edit?gid=..." />
	  </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>
        ë‚ ì§œ (YYYY-MM-DD)
        <input id="dateStr" value="" />
        <span class="muted">íƒ€ì„ìŠ¤íƒ¬í”„ ë‚ ì§œ ê¸°ì¤€</span>
      </label>

      <label>
        íŒ€ ì„ íƒ
        <select id="groupType">
          <option value="ë“œë¦¼">ë“œë¦¼</option>
          <option value="ìš°ë¦¬">ìš°ë¦¬</option>
		  <option value="ì„¬ê¹€">ì„¬ê¹€</option>
		  <option value="ì˜ˆë°°">ì˜ˆë°°</option>
        </select>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>
        ë“œë¦¼ë°˜ ì•„ì´ì½˜(ì´ëª¨ì§€)
        <input id="emojiDream" value="ğŸ¿" />
      </label>
      <label>
        ìš°ë¦¬ë°˜ ì•„ì´ì½˜(ì´ëª¨ì§€)
        <input id="emojiUri" value="ğŸ»" />
      </label>
      <label>
        ìƒˆì¹œêµ¬ë°˜ ì•„ì´ì½˜(ì´ëª¨ì§€)
        <input id="emojiNew" value="ğŸ£" />
      </label>
	  <label>
	    ì„¬ê¹€íŒ€ ì•„ì´ì½˜(ì´ëª¨ì§€)
	    <input id="emojiServe" value="ğŸ¤" />
	  </label>
	  <label>
	    ì˜ˆë°°íŒ€ ì•„ì´ì½˜(ì´ëª¨ì§€)
	    <input id="emojiWorship" value="ğŸ¶" />
	  </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>
        ì œëª© ì•/ë’¤ ì´ëª¨ì§€(ê¸°ë³¸ ğŸ”¥)
        <input id="emojiTitle" value="ğŸ”¥" />
        <span class="muted">ì˜ˆ: ğŸ”¥ì–‘ìœ¡íŒ€ ë“œë¦¼ë°˜ ê¸°ë„ì œëª©ğŸ”¥</span>
      </label>
      <label>
        â€œì˜ˆê¼¬:â€ ë¼ë²¨(ì´ëª¨ì§€ í¬í•¨)
        <input id="labelYekko" value="ì˜ˆê¼¬:" />
        <span class="muted">ì˜ˆ: ğŸ§’ì˜ˆê¼¬: / âœ¨ì˜ˆê¼¬:</span>
      </label>
      <label>
        â€œêµì‚¬:â€ ë¼ë²¨(ì´ëª¨ì§€ í¬í•¨)
        <input id="labelTeacher" value="êµì‚¬:" />
        <span class="muted">ì˜ˆ: ğŸ™êµì‚¬: / ğŸ‘©â€ğŸ«êµì‚¬:</span>
      </label>
    </div>

    <div class="actions">
      <button id="saveBtn" type="button">ì„¤ì • ì €ì¥</button>
      <button id="loadBtn" type="button">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="runBtn" class="primary" type="button">ê°€ì ¸ì˜¤ê¸° & ìƒì„±</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="err" class="error"></div>
  </div>

  <div class="card">
    <div class="muted">
      <span class="pill">Copyê°€ ì£¼ ê¸°ëŠ¥</span>
      <span class="pill">ì¤‘ë³µ(ë°˜+êµì‚¬) ìµœì‹  ë®ì–´ì“°ê¸°</span>
      <span class="pill">ì»¬ëŸ¼ í‚¤ì›Œë“œ ìë™ íƒìƒ‰</span>
    </div>

    <div class="actions" style="margin-top:10px;">
      <button id="copyBtn" type="button">ğŸ“‹ Copy</button>
      <span id="copyStatus" class="muted"></span>
    </div>

    <textarea id="outText" placeholder="ì—¬ê¸°ì— ê²°ê³¼ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤."></textarea>
  </div>

<script>
/* =========================
   LocalStorage Config
========================= */
const LS_KEY = "prayer_app_config_v1";

function todaySeoulYYYYMMDD(){
  // ë‹¨ìˆœ local ê¸°ì¤€ (í°ì—ì„œ í•œêµ­ì´ë©´ ëŒ€ë¶€ë¶„ OK)
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function getEl(id){ return document.getElementById(id); }

function readConfig(){
  return {
    dreamUrl: getEl("dreamUrl").value.trim(),
    uriUrl: getEl("uriUrl").value.trim(),
    dateStr: getEl("dateStr").value.trim(),
    groupType: getEl("groupType").value,
    emojiDream: getEl("emojiDream").value.trim() || "ğŸ¿",
    emojiUri: getEl("emojiUri").value.trim() || "ğŸ»",
    emojiNew: getEl("emojiNew").value.trim() || "ğŸ£",
    emojiTitle: getEl("emojiTitle").value.trim() || "ğŸ”¥",
	emojiServe: (getEl("emojiServe").value || "").trim() || "ğŸ¤",
	emojiWorship: (getEl("emojiWorship").value || "").trim() || "ğŸ¶",
    labelYekko: getEl("labelYekko").value.trim() || "ì˜ˆê¼¬:",
    labelTeacher: getEl("labelTeacher").value.trim() || "êµì‚¬:",
	serveUrl: getEl("serveUrl").value.trim(),
	worshipUrl: getEl("worshipUrl").value.trim(),
  };
}
function applyConfig(cfg){
  getEl("dreamUrl").value = cfg.dreamUrl || "";
  getEl("uriUrl").value = cfg.uriUrl || "";
  getEl("dateStr").value = cfg.dateStr || todaySeoulYYYYMMDD();
  getEl("groupType").value = cfg.groupType || "ë“œë¦¼";
  getEl("emojiDream").value = cfg.emojiDream || "ğŸ¿";
  getEl("emojiUri").value = cfg.emojiUri || "ğŸ»";
  getEl("emojiNew").value = cfg.emojiNew || "ğŸ£";
  getEl("emojiTitle").value = cfg.emojiTitle || "ğŸ”¥";
  getEl("emojiServe").value = cfg.emojiServe || "ğŸ¤";
  getEl("emojiWorship").value = cfg.emojiWorship || "ğŸ¶";
  getEl("labelYekko").value = cfg.labelYekko || "ì˜ˆê¼¬:";
  getEl("labelTeacher").value = cfg.labelTeacher || "êµì‚¬:";
  getEl("serveUrl").value = cfg.serveUrl || "";
  getEl("worshipUrl").value = cfg.worshipUrl || "";
}

function saveConfig(){
  const cfg = readConfig();
  localStorage.setItem(LS_KEY, JSON.stringify(cfg));
  return cfg;
}
function loadConfig(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) {
    const def = {
      dreamUrl: "https://docs.google.com/spreadsheets/d/1q1bX3yUdpa5FLBgQqFNtx-rINidCBEO45uiY4-__NHE/edit?gid=1188634731#gid=1188634731",
      uriUrl: "https://docs.google.com/spreadsheets/d/1BWStkKjkZ5b8ETDOQbpX2AUe9ZGMUSA-65IWCwksujs/edit?gid=676599151#gid=676599151",
      serveUrl: "https://docs.google.com/spreadsheets/d/1-n0kqYgC_-KslH0WZPV-FtPcSEbzupfPLKfjRdAT_O4/edit?gid=120385715#gid=120385715",
	  worshipUrl: "https://docs.google.com/spreadsheets/d/1papF3k_vDfoWwg8srr27eG422usqRXfLLh7d6VUoelg/edit?gid=1457397190#gid=1457397190",
	  dateStr: todaySeoulYYYYMMDD(),
      groupType: "ë“œë¦¼",
      emojiDream: "ğŸ¿",
      emojiUri: "ğŸ»",
      emojiNew: "ğŸ£",
      emojiTitle: "ğŸ”¥",
	  emojiServe: "ğŸ¤",
	  emojiWorship: "ğŸ¶",
      labelYekko: "  ğŸ§’ ì˜ˆê¼¬:",
	  labelTeacher: "  ğŸ‘©â€ êµì‚¬:",
    };
    localStorage.setItem(LS_KEY, JSON.stringify(def));
    return def;
  }
  try { return JSON.parse(raw); } catch { return null; }
}

/* =========================
   Google Sheets GViz(JSONP) fetch
   - Works without CORS via <script src=...>
========================= */
function parseSheetIdAndGid(url) {
  const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (!m) return null;
  const sheetId = m[1];

  let gid = null;
  try {
    const u = new URL(url);
    gid = u.searchParams.get("gid") || gid;
    if (!gid && u.hash) {
      const hm = u.hash.match(/gid=(\d+)/);
      if (hm) gid = hm[1];
    }
  } catch (e) {
    const gm = url.match(/gid=(\d+)/);
    if (gm) gid = gm[1];
  }
  return { sheetId, gid };
}

function makeGvizUrl(sheetId, gid, callbackName) {
  // tqx=out:json is already JSONP-like: google.visualization.Query.setResponse(...)
  // We attach a callback by wrapping setResponse through our own hook.
  // Easiest: use tqx=out:json and intercept global google.visualization.Query.setResponse.
  // But that can conflict if multiple requests.
  // Alternative: tqx=out:json;responseHandler=CALLBACK (works on some endpoints)
  // Most stable in practice: use out:json + override setResponse temporarily.

  // We'll use out:json and override setResponse safely per request.
  const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?`;
  const params = new URLSearchParams();
  if (gid) params.set("gid", gid);
  params.set("tqx", "out:json");
  // we can also pass a trivial query; empty uses whole sheet
  // params.set("tq", "select *");
  return base + params.toString();
}

function gvizFetch(sheetUrl) {
  return new Promise((resolve, reject) => {
    const parsed = parseSheetIdAndGid(sheetUrl);
    if (!parsed) return reject(new Error("ì‹œíŠ¸ ë§í¬ì—ì„œ SHEET_IDë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆì–´ìš”."));

    const { sheetId, gid } = parsed;
    const src = makeGvizUrl(sheetId, gid);

    // ensure google namespace exists
    window.google = window.google || {};
    google.visualization = google.visualization || {};
    google.visualization.Query = google.visualization.Query || {};

    const old = google.visualization.Query.setResponse;

    const timer = setTimeout(() => {
      google.visualization.Query.setResponse = old;
      script.remove();
      reject(new Error("GViz ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤(ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ í™•ì¸)."));
    }, 25000);

    google.visualization.Query.setResponse = (resp) => {
      clearTimeout(timer);
      google.visualization.Query.setResponse = old;
      script.remove();
      if (!resp || resp.status !== "ok") {
        const msg = (resp && resp.errors && resp.errors[0] && resp.errors[0].detailed_message) || "GViz ì‘ë‹µ ì˜¤ë¥˜";
        reject(new Error(msg));
        return;
      }
      resolve(resp.table);
    };

    const script = document.createElement("script");
    script.src = src;
    script.onerror = () => {
      clearTimeout(timer);
      google.visualization.Query.setResponse = old;
      script.remove();
      reject(new Error("ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. (ë§í¬ ê³µê°œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸)"));
    };
    document.body.appendChild(script);
  });
}

/* =========================
   Table -> Rows
========================= */
function tableToObjects(table) {
  // table.cols: [{label, type}, ...]
  // table.rows: [{c:[{v, f}, ...]}, ...]
  const headers = (table.cols || []).map(c => (c.label || "").trim());
  const out = [];

  for (const r of (table.rows || [])) {
    const obj = {};
    const cells = (r.c || []);
    headers.forEach((h, idx) => {
      const cell = cells[idx] || {};
      // v may be null, string, number, Date(...) string
      obj[h] = cell.v;
    });
    out.push(obj);
  }
  return { headers, rows: out };
}

/* =========================
   Helpers: column find + cleaning + timestamp parsing
========================= */
function norm(s){ return String(s ?? "").replace(/\s+/g,"").toLowerCase(); }

function findCol(headers, keywords) {
  const nheaders = headers.map(h => ({ raw: h, n: norm(h) }));
  const nkw = keywords.map(k => norm(k));

  // strict all keywords
  for (const h of nheaders) {
    if (nkw.every(k => h.n.includes(k))) return h.raw;
  }
  // loose any keyword
  for (const h of nheaders) {
    if (nkw.some(k => h.n.includes(k))) return h.raw;
  }
  throw new Error(`í‚¤ì›Œë“œ ${keywords.join(", ")} ë¡œ ì»¬ëŸ¼ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.\nì‹¤ì œ ì»¬ëŸ¼: ${headers.join(" / ")}`);
}

function cleanClassName(s){
  return String(s ?? "").replace(/[^0-9ê°€-í£]/g,"").trim();
}
function cleanTeacherName(s){
  return String(s ?? "").replace(/[^ê°€-í£]/g,"").trim();
}
function cleanText(v){
  if (v === null || v === undefined) return "";
  const s = String(v).trim();
  if (!s) return "";
  if (s.toLowerCase() === "nan") return "";
  return s;
}

function parseTsToYYYYMMDD(tsVal){
  // GViz may return:
  // 1) "Date(2026,0,4,13,30,43)"
  // 2) a JS Date object? (rare)
  // 3) string like "2026. 1. 4 ì˜¤í›„ 1:30:43"
  // 4) string like "2026-01-04 13:30:43"
  if (tsVal === null || tsVal === undefined) return null;

  // Date object
  if (tsVal instanceof Date && !isNaN(tsVal)) {
    const y = tsVal.getFullYear();
    const m = String(tsVal.getMonth()+1).padStart(2,"0");
    const d = String(tsVal.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  const ts = String(tsVal).trim();

  // Date(yyyy,mm,dd,hh,mi,ss)
  const dm = ts.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})(?:,(\d{1,2}),(\d{1,2}),(\d{1,2}))?\)$/);
  if (dm) {
    const y = Number(dm[1]);
    const mo = Number(dm[2]) + 1;
    const da = Number(dm[3]);
    return `${y}-${String(mo).padStart(2,"0")}-${String(da).padStart(2,"0")}`;
  }

  // Korean AM/PM: 2026. 1. 4 ì˜¤í›„ 1:30:43
  const km = ts.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (km) {
    const y = Number(km[1]);
    const mo = Number(km[2]);
    const da = Number(km[3]);
    return `${y}-${String(mo).padStart(2,"0")}-${String(da).padStart(2,"0")}`;
  }

  // ISO-ish parse
  const d = new Date(ts);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  return null;
}

function parseTsToDate(tsVal){
  // for dedupe latest
  if (tsVal === null || tsVal === undefined) return null;

  if (tsVal instanceof Date && !isNaN(tsVal)) return tsVal;

  const ts = String(tsVal).trim();

  const dm = ts.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})(?:,(\d{1,2}),(\d{1,2}),(\d{1,2}))?\)$/);
  if (dm) {
    const y = Number(dm[1]);
    const mo = Number(dm[2]); // 0-based
    const da = Number(dm[3]);
    const hh = Number(dm[4] || 0);
    const mi = Number(dm[5] || 0);
    const ss = Number(dm[6] || 0);
    return new Date(y, mo, da, hh, mi, ss);
  }

  // Korean AM/PM
  const km = ts.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (km) {
    const y = Number(km[1]);
    const mo = Number(km[2]) - 1;
    const da = Number(km[3]);
    const ap = km[4];
    let hh = Number(km[5]);
    const mi = Number(km[6]);
    const ss = Number(km[7] || 0);
    if (ap === "ì˜¤í›„" && hh < 12) hh += 12;
    if (ap === "ì˜¤ì „" && hh === 12) hh = 0;
    return new Date(y, mo, da, hh, mi, ss);
  }

  const d = new Date(ts);
  if (!isNaN(d)) return d;
  return null;
}

/* =========================
   Formatting output
========================= */
const numEmoji = {
  "0":"0âƒ£","1":"1âƒ£","2":"2âƒ£","3":"3âƒ£","4":"4âƒ£",
  "5":"5âƒ£","6":"6âƒ£","7":"7âƒ£","8":"8âƒ£","9":"9âƒ£"
};
function toEmojiNum(s){
  return String(s).split("").map(ch => numEmoji[ch] || ch).join("");
}

function makeHeaderTitle(dateStr, groupType, emojiTitle){
  const e = emojiTitle || "ğŸ”¥";

  // íŒ€ëª… ê²°ì •
  const team =
    (groupType === "ì„¬ê¹€") ? "ì„¬ê¹€íŒ€" :
    (groupType === "ì˜ˆë°°") ? "ì˜ˆë°°íŒ€" :
    "ì–‘ìœ¡íŒ€";

  // ë¶€ê°€ ë¼ë²¨(ë°˜)
  const suffix =
    (groupType === "ë“œë¦¼") ? " ë“œë¦¼ë°˜" :
    (groupType === "ìš°ë¦¬") ? " ìš°ë¦¬ë°˜" :
    ""; // ì„¬ê¹€/ì˜ˆë°°ëŠ” ì—†ìŒ

  return `${dateStr}\n${e}${team}${suffix} ê¸°ë„ì œëª©${e}\n\n\n`;
}

function classDisplayName(className, groupType, emojiDream, emojiUri, emojiNew){
  // ìƒˆì¹œêµ¬ë°˜ first
  if (className === "ìƒˆì¹œêµ¬ë°˜") return `${emojiNew}ìƒˆì¹œêµ¬ë°˜`;
  const icon = className.startsWith("ë“œë¦¼") ? emojiDream : emojiUri;

  // "ë“œë¦¼2ë°˜" -> "ë“œë¦¼ 2âƒ£ë°˜"
  const m = className.match(/(\d+)/);
  if (!m) return `${icon}${className}`;
  const num = m[1];
  const withEmoji = toEmojiNum(num);
  const pretty = className.replace(num, ` ${withEmoji}`);
  return `${icon}${pretty}`;
}

function formatBlocks(items, cfg){
  const lines = [];
  lines.push(makeHeaderTitle(cfg.dateStr, cfg.groupType, cfg.emojiTitle).trimEnd());
  lines.push(""); // âœ… ì´ê²Œ ì§„ì§œ ë¹ˆ ì¤„ 1ì¤„

  for (const it of items) {
    const title = `${classDisplayName(it.className, cfg.groupType, cfg.emojiDream, cfg.emojiUri, cfg.emojiNew)}ğŸ™${it.teacherName}`;
    lines.push(title);
    lines.push(`${cfg.labelYekko}`);
    lines.push(it.yekkoPrayer || "");
    lines.push(`${cfg.labelTeacher}`);
    lines.push(it.teacherPrayer || "");
    lines.push(""); // blank line between blocks
  }
  // remove trailing blank lines
  while (lines.length && lines[lines.length-1] === "") lines.pop();
  return lines.join("\n");
}

function formatSimpleList(items, cfg){
  const lines = [];
  lines.push(makeHeaderTitle(cfg.dateStr, cfg.groupType, cfg.emojiTitle).trimEnd());

  for (const it of items) {
    const leadEmoji =
	  (cfg.groupType === "ì„¬ê¹€") ? (cfg.emojiServe || "ğŸ¤") :
	  (cfg.groupType === "ì˜ˆë°°") ? (cfg.emojiWorship || "ğŸ¶") :
	  "ğŸ™";

	if (it.name) lines.push(`${leadEmoji}${it.name}`);
    if (it.prayer) lines.push(it.prayer);
    lines.push("");
  }
  while (lines.length && lines[lines.length-1] === "") lines.pop();
  return lines.join("\n");
}


/* =========================
   Main: run
========================= */
const statusEl = getEl("status");
const errEl = getEl("err");
const outText = getEl("outText");
const copyStatus = getEl("copyStatus");

async function run(){
  errEl.textContent = "";
  copyStatus.textContent = "";
  statusEl.textContent = "";
  outText.value = "";

  const cfg = saveConfig();

  if (!/^\d{4}-\d{2}-\d{2}$/.test(cfg.dateStr)) {
    errEl.textContent = "ë‚ ì§œ í˜•ì‹ì€ YYYY-MM-DD ë¡œ ì…ë ¥. ì˜ˆ: 2026-01-04";
    return;
  }

  function getSheetUrl(cfg){
	if (cfg.groupType === "ë“œë¦¼") return cfg.dreamUrl;
	if (cfg.groupType === "ìš°ë¦¬") return cfg.uriUrl;
	if (cfg.groupType === "ì„¬ê¹€") return cfg.serveUrl;
	if (cfg.groupType === "ì˜ˆë°°") return cfg.worshipUrl;
	return "";
  }
  
  const sheetUrl = getSheetUrl(cfg);
  if (!sheetUrl || !sheetUrl.includes("docs.google.com/spreadsheets")) {
    errEl.textContent = `${cfg.groupType}ë°˜ ì‹œíŠ¸ ë§í¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥.`;
    return;
  }

  try {
    statusEl.textContent = "ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘(GViz)...";
    const table = await gvizFetch(sheetUrl);

    statusEl.textContent = "ë°ì´í„° ì •ë¦¬ ì¤‘...";
    const { headers, rows } = tableToObjects(table);

  const isSimple = (cfg.groupType === "ì„¬ê¹€" || cfg.groupType === "ì˜ˆë°°");
  
  if (isSimple) {
    // column detection (simple)
    const COL_TS = findCol(headers, ["íƒ€ì„ìŠ¤íƒ¬í”„"]);
    const COL_NAME = findCol(headers, ["ì´ë¦„"]);      // í•„ìš”ì‹œ ["ì„±ëª…"] ë“± ì¶”ê°€
    const COL_PRAYER = findCol(headers, ["ê¸°ë„"]);    // í•„ìš”ì‹œ ["ê¸°ë„ì œëª©"] ì¶”ê°€
  
    const targetDate = cfg.dateStr;
  
    let items = [];
    for (const r of rows) {
      const d = parseTsToYYYYMMDD(r[COL_TS]);
      if (d !== targetDate) continue;
  
      const tsDate = parseTsToDate(r[COL_TS]);
      if (!tsDate) continue;
  
      const name = cleanText(r[COL_NAME]);
      const prayer = cleanText(r[COL_PRAYER]);
      if (!name && !prayer) continue;
  
      items.push({ name, prayer, _ts: tsDate });
    }
  
    // ìµœì‹ ìˆœ
    items.sort((a,b) => (b._ts - a._ts));
  
    outText.value = formatSimpleList(items, cfg) || `${cfg.dateStr}\n(ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.)`;
  
    statusEl.textContent = `ì™„ë£Œ! ${items.length}ê±´`;
    statusEl.className = "muted ok";
    return; // âœ… ì—¬ê¸°ì„œ ëë‚´ì•¼ ë“œë¦¼/ìš°ë¦¬ ë¡œì§ìœ¼ë¡œ ì•ˆ ë‚´ë ¤ê°
  }

    // column detection
    const COL_TS = findCol(headers, ["íƒ€ì„ìŠ¤íƒ¬í”„"]);
    const COL_CLASS = findCol(headers, ["ë°˜","ì´ë¦„"]);
    const COL_TEACHER = findCol(headers, ["êµì‚¬","ì´ë¦„"]);
    const COL_YEKKO = findCol(headers, ["ì˜ˆê¼¬","ê¸°ë„"]);
    const COL_TPRAYER = findCol(headers, ["êµì‚¬","ê¸°ë„"]);

    const targetDate = cfg.dateStr;
    const groupPrefix = cfg.groupType;

    // dedupe: key=(class,teacher) keep latest timestamp
    const latest = new Map();

    for (const r of rows) {
      const d = parseTsToYYYYMMDD(r[COL_TS]);
      if (d !== targetDate) continue;

      const tsDate = parseTsToDate(r[COL_TS]);
      if (!tsDate) continue;

      const className = cleanClassName(r[COL_CLASS]);
      if (!(className.startsWith(groupPrefix) || className === "ìƒˆì¹œêµ¬ë°˜")) continue;

      const teacherName = cleanTeacherName(r[COL_TEACHER]);

      const item = {
        date: d,
        className,
        teacherName,
        yekkoPrayer: cleanText(r[COL_YEKKO]),
        teacherPrayer: cleanText(r[COL_TPRAYER]),
        _ts: tsDate
      };

      const key = `${className}||${teacherName}`;
      const prev = latest.get(key);
      if (!prev || item._ts > prev._ts) latest.set(key, item);
    }

    let items = Array.from(latest.values());

    // sort: ìƒˆì¹œêµ¬ë°˜ first, then numeric order
    function classSortKey(name){
      if (name === "ìƒˆì¹œêµ¬ë°˜") return [0, 0];
      const m = name.match(/(\d+)/);
      const n = m ? parseInt(m[1],10) : 9999;
      return [1, n];
    }
    items.sort((a,b) => {
      const ka = classSortKey(a.className);
      const kb = classSortKey(b.className);
      if (ka[0] !== kb[0]) return ka[0]-kb[0];
      if (ka[1] !== kb[1]) return ka[1]-kb[1];
      return a.teacherName.localeCompare(b.teacherName);
    });

    const remind = formatBlocks(items, cfg);
    outText.value = remind || `${cfg.dateStr}\n(ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.)`;

    statusEl.textContent = `ì™„ë£Œ! ${items.length}ê±´`;
    statusEl.className = "muted ok";

  } catch (e) {
    statusEl.textContent = "";
    statusEl.className = "muted";
    errEl.textContent =
      "ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ì›ì¸ í›„ë³´:\n" +
      "1) ì‹œíŠ¸ê°€ 'ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì ë³´ê¸°'ê°€ ì•„ë‹˜\n" +
      "2) GIDê°€ ì˜ëª»ëœ ë§í¬\n" +
      "3) ë„¤íŠ¸ì›Œí¬/ë°ì´í„° ë¡œë”© ì§€ì—°\n\n" +
      "ì—ëŸ¬ ìƒì„¸:\n" + (e && e.message ? e.message : String(e));
  }
}

/* =========================
   Copy (works on mobile)
========================= */
async function copyText(){
  copyStatus.textContent = "";
  const text = outText.value || "";
  if (!text.trim()) {
    copyStatus.textContent = "ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ì–´ìš”.";
    return;
  }

  // Prefer modern clipboard (requires secure context; may fail on file://)
  try {
    await navigator.clipboard.writeText(text);
    copyStatus.textContent = "ë³µì‚¬ ì™„ë£Œ! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ë©´ ë¼ìš”.";
    copyStatus.className = "muted ok";
    return;
  } catch (e) {
    // Fallback: select + execCommand
    try {
      outText.focus();
      outText.select();
      document.execCommand("copy");
      copyStatus.textContent = "ë³µì‚¬ ì™„ë£Œ! (ëŒ€ì²´ ë°©ì‹)";
      copyStatus.className = "muted ok";
      return;
    } catch (e2) {
      copyStatus.textContent = "ë³µì‚¬ ì‹¤íŒ¨: í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì „ì²´ì„ íƒâ†’ë³µì‚¬.";
      copyStatus.className = "muted";
    }
  }
}

/* =========================
   Wire up
========================= */
getEl("saveBtn").onclick = () => {
  saveConfig();
  statusEl.textContent = "ì„¤ì • ì €ì¥ë¨";
  statusEl.className = "muted ok";
};
getEl("loadBtn").onclick = () => {
  const cfg = loadConfig();
  if (cfg) applyConfig(cfg);
  statusEl.textContent = "ì„¤ì • ë¶ˆëŸ¬ì˜´";
  statusEl.className = "muted ok";
};
getEl("runBtn").onclick = run;
getEl("copyBtn").onclick = copyText;

// init
(() => {
  const cfg = loadConfig();
  if (cfg) applyConfig(cfg);
  if (!getEl("dateStr").value) getEl("dateStr").value = todaySeoulYYYYMMDD();
})();
</script>
<footer style=" position: fixed; right: 8px; bottom: 6px; font-size: 11px; color: #999; "> Â© 2026 Onsfamily </footer>
</body>
</html>
